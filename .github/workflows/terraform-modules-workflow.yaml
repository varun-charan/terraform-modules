name: Terraform Modules CI

on:
  push:
    branches:
      # Meant for NETxxyy-* tickets
      - feature/*
      # Meant for DEVOPS-* tickets
      - hotfix/*
    # DO NOT trigger workflow run on updates to templates
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.tflint/**'
  pull_request:
    types:
      - opened
      - synchronize
    branches:
      # Meant for running after PR merged on master
      - master
    # DO NOT trigger workflow run on updates to templates
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '.tflint/**'
  # For manual trigger of job, if required. Avoids need to use dummy commits to initiate workflow.Applicable to master branch only since for it, source tag is picked from Git tags and not from Commit hash as is the case for dev branches.
  workflow_dispatch:

jobs:
  # # U S I N G   P Y A C T I O N
  # exec_command:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Test pyaction with exec devops cli command
  #     uses: varun-charan/pyaction@v0.5.0
  #     with:
  #       index_url_pip: ${{ secrets.INDEX_URL_PIP }}
  #       command: "exec"
  #       args: "python3 --version"
  
  # non_exec_command:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     stdout: ${{ steps.pyaction_non_exec_cmd.outputs.stdout }}
  #   steps:
  #   - name: Test pyaction with non-exec devops cli command
  #     id: pyaction_non_exec_cmd
  #     uses: varun-charan/pyaction@v0.5.0
  #     env:
  #       VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
  #       VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
  #     with:
  #       devops_version: "v0.5.0"
  #       index_url_pip: ${{ secrets.INDEX_URL_PIP }}
  #       export_list: "VAULT_ADDR=${{ env.VAULT_ADDR }}, VAULT_TOKEN=${{ env.VAULT_TOKEN }}"
  #       command: "vault"
  #       subcommand: "get"
  #       args: "prd/devops/newreleases automation_api_key"

  # test_vault_output:
  #   runs-on: ubuntu-latest
  #   needs: [ non_exec_command ]
  #   steps:
  #     - name: Test if pyaction vault command returned correct output
  #       shell: bash
  #       run: |
  #         echo "::add-mask::$API_KEY"
  #         curl --location --request GET 'https://api.newreleases.io/v1/projects' --header 'X-Key: ${{ env.API_KEY }}'
  #       env:
  #         API_KEY: ${{ needs.non_exec_command.outputs.stdout }}

  build:
    runs-on: ubuntu-latest  # windows-latest | macos-latest
    name: Test changed-files
    steps:
      # Checkout master branch
      - id: get_master_sha
        uses: actions/checkout@v3
        with:
          ref: master

      - run: |
          echo "${{ join(steps.get_master_sha.outputs.*, '\n') }}"

      # Get diff with master branch
      - name: Run changed-files with dir_names
        id: changed-files-dir-names
        uses: tj-actions/changed-files@v35
        with:
          dir_names: "true"
          json: "true"
          base_sha: ${{ steps.get_master_sha.outputs.commit }}
          # output_dir: "true"
          # write_output_files: "true"

      - name: List all changed files
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "$file was changed"
          done

  # T E R R A F O R M   C I C D 
  get_target_modules:
    runs-on: ubuntu-latest
    outputs:
      tf_modules: ${{ steps.get_target_tf_modules.outputs.tf_modules }}
    steps:
      - name: Checkout application GitHub repo
        uses: actions/checkout@v3

      - name: Get target TF modules
        id: get_target_tf_modules
        shell: bash
        run: |
          git fetch origin master

          if [ -z `git diff --dirstat=files,0 --name-only origin/master | grep -v .github | grep -v .tflint` ]; then
            CHANGED_TF_MODULES_JSON=$(printf '[]\n')

            echo "TF Modules JSON: " $CHANGED_TF_MODULES_JSON
          else
            CHANGED_TF_MODULES=`git diff --dirstat=files,0 --name-only origin/master | sed -E 's/^[ 0-9.]+% //g' | cut -d '/' -f1 | grep -v .github | grep -v .tflint | uniq | sort`

            echo "TF Modules: " $CHANGED_TF_MODULES

            if [ -z "$CHANGED_TF_MODULES" ]; then
              CHANGED_TF_MODULES_JSON=$(printf '[]\n')
            else
              CHANGED_TF_MODULES_JSON=$(printf '['; for i in ${CHANGED_TF_MODULES[@]}; do printf ' \"%s\", ' $i; done | sed 's/,\([^,]*\)$/\1/'; printf ']\n')
            fi

            echo "TF Modules JSON: " $CHANGED_TF_MODULES_JSON
          fi

          echo "::set-output name=tf_modules::$CHANGED_TF_MODULES_JSON"

  static-analysis:
    needs: [ get_target_modules ]
    runs-on: ubuntu-latest
    if: needs.get_target_modules.outputs.tf_modules != '[]'
    strategy:
      matrix:
        TF_MODULE: "${{ fromJson(needs.get_target_modules.outputs.tf_modules) }}"
    steps:
    - name: Checkout application GitHub repo
      uses: actions/checkout@v3

    - name: Setup Terraform  
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.0.11

    - name: Terraform Format
      id: fmt
      run: terraform -chdir=${{ matrix.TF_MODULE }} fmt -check -recursive -diff

    - name: Terraform Init
      id: init
      run: terraform -chdir=${{ matrix.TF_MODULE }} init

    - name: Terraform Validate
      id: validate
      run: terraform -chdir=${{ matrix.TF_MODULE }} validate

    - uses: actions/cache@v2
      name: Cache plugin dir
      with:
        path: ~/.tflint.d/plugins
        key: tflint-${{ hashFiles('.tflint/tflint.hcl') }}
    
    - name: Setup TFLint
      uses: terraform-linters/setup-tflint@v2
      with:
        tflint_version: v0.44.1

    - name: Init TFLint
      run: tflint --chdir=${{ matrix.TF_MODULE }} --config=$(realpath .tflint/tflint.hcl) --init 

    - name: Run TFLint
      run: tflint --chdir=${{ matrix.TF_MODULE }} --config=$(realpath .tflint/tflint.hcl)

    # - name: Get AWS Access Key ID
    #   id: aws_access_key_id
    #   uses: varun-charan/pyaction@v0.5.0
    #   env:
    #     VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
    #     VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
    #   with:
    #     devops_version: "v0.5.0"
    #     index_url_pip: ${{ secrets.INDEX_URL_PIP }}
    #     export_list: "VAULT_ADDR=${{ env.VAULT_ADDR }}, VAULT_TOKEN=${{ env.VAULT_TOKEN }}"
    #     command: "vault"
    #     subcommand: "get"
    #     args: "prd/devops/aws/api-users/barco-eci-sandbox AWS_ACCESS_KEY_ID"
    
    # - name: Get AWS Secret Access Key
    #   id: aws_secret_access_key
    #   uses: varun-charan/pyaction@v0.5.0
    #   env:
    #     VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
    #     VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
    #   with:
    #     devops_version: "v0.5.0"
    #     index_url_pip: ${{ secrets.INDEX_URL_PIP }}
    #     export_list: "VAULT_ADDR=${{ env.VAULT_ADDR }}, VAULT_TOKEN=${{ env.VAULT_TOKEN }}"
    #     command: "vault"
    #     subcommand: "get"
    #     args: "prd/devops/aws/api-users/barco-eci-sandbox AWS_SECRET_ACCESS_KEY"

    # - name: Terraform Plan
    #   env:
    #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #   id: plan
    #   run: |
    #     echo "::add-mask::$AWS_ACCESS_KEY_ID"
    #     echo "::add-mask::$AWS_SECRET_ACCESS_KEY"
    #     export AWS_ACCESS_KEY_ID=${{ env.AWS_ACCESS_KEY_ID }}
    #     export AWS_SECRET_ACCESS_KEY=${{ env.AWS_SECRET_ACCESS_KEY }}
    #     terraform -chdir=${{ matrix.TF_MODULE }} plan -var-file=.ci/tfplan.tfvars
    #   continue-on-error: true
  
    # - name: Update Pull Request
    #   uses: actions/github-script@v6
    #   if: github.event_name == 'pull_request'
    #   env:
    #     PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
    #   with:
    #     github-token: ${{ secrets.GITHUB_TOKEN }}
    #     script: |
    #       const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
    #       #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
    #       #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
    #       #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`

    #       <details><summary>Show Plan</summary>

    #       \`\`\`\n
    #       ${process.env.PLAN}
    #       \`\`\`

    #       </details>

    #       *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

    #       github.rest.issues.createComment({
    #         issue_number: context.issue.number,
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         body: output
    #       })

    # - name: Terraform Plan Status
    #   if: steps.plan.outcome == 'failure'
    #   run: exit 1

  perform_security_scan:
    needs: [ get_target_modules ]
    uses: varun-charan/reusable-workflows/.github/workflows/iac-security-scans.yaml@master
    with:
      upload_sarif: true
      target_dirs: ${{ needs.get_target_modules.outputs.tf_modules }}
      severity: "low"
      terrascan_iac_type: "terraform"
      terrascan_iac_version: "v15"
    secrets:
      snyk_auth_token: ${{ secrets.SNYK_AUTH_TOKEN }}

  calculate_infra_cost:
    needs: [ get_target_modules ]
    uses: varun-charan/reusable-workflows/.github/workflows/calculate-infracost.yaml@master
    with:
      target_dirs: ${{ needs.get_target_modules.outputs.tf_modules }}
    secrets:
      infracost_api_key: ${{ secrets.INFRACOST_API_KEY }}

  # run_terraform_apply:
  #   needs: [get_target_modules, static-analysis, perform_security_scan, calculate_infra_cost]
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/master' && github.event_name == 'push'
  #   env:
  #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #   strategy:
  #     matrix:
  #       TF_MODULE: "${{ fromJson(needs.get_target_modules.outputs.tf_modules) }}"
  #   steps:
  #     - run: terraform -chdir=${{ matrix.TF_MODULE }} apply -auto-approve -var-file=.ci/tfplan.tfvars
  