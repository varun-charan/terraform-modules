name: consume-custom-action

on:
  push:
    branches:
      # Meant for NETxxyy-* tickets
      - feature/*
      # Meant for DEVOPS-* tickets
      - hotfix/*
    # DO NOT trigger workflow run on updates to templates
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
  pull_request:
    types:
      - closed
      - synchronize
    branches:
      # Meant for running after PR merged on master
      - master
    # DO NOT trigger workflow run on updates to templates
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
  # For manual trigger of job, if required. Avoids need to use dummy commits to initiate workflow.Applicable to master branch only since for it, source tag is picked from Git tags and not from Commit hash as is the case for dev branches.
  workflow_dispatch:

jobs:
  # U S I N G   P Y A C T I O N
  exec_command:
    runs-on: ubuntu-latest
    steps:
    - name: Test pyaction with exec devops cli command
      uses: varun-charan/pyaction@v0.4.0
      with:
        index_url_pip: ${{ secrets.INDEX_URL_PIP }}
        command: "exec"
        args: "python3 --version"
  
  non_exec_command:
    runs-on: ubuntu-latest
    outputs:
      stdout: ${{ steps.pyaction_non_exec_cmd.outputs.stdout }}
    steps:
    - name: Test pyaction with non-exec devops cli command
      id: pyaction_non_exec_cmd
      uses: varun-charan/pyaction@v0.4.0
      env:
        VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
      with:
        index_url_pip: ${{ secrets.INDEX_URL_PIP }}
        export_list: "VAULT_ADDR=${{ env.VAULT_ADDR }}, VAULT_TOKEN=${{ env.VAULT_TOKEN }}"
        command: "vault"
        subcommand: "get"
        args: "prd/devops/newreleases automation_api_key"

  test_vault_output:
    runs-on: ubuntu-latest
    needs: [ non_exec_command ]
    steps:
      - name: Test if pyaction vault command returned correct output
        shell: bash
        run: |
          echo "::add-mask::$API_KEY"
          curl --location --request GET 'https://api.newreleases.io/v1/projects' --header 'X-Key: ${{ env.API_KEY }}'
        env:
          API_KEY: ${{ needs.non_exec_command.outputs.stdout }}

  # T E R R A F O R M   C I C D 
  get_target_modules:
    runs-on: ubuntu-latest
    outputs:
      tf_modules: ${{ steps.get_target_tf_modules.outputs.tf_modules }}
    steps:
      - name: Checkout application GitHub repo
        uses: actions/checkout@v3
      
      - name: Get target TF modules
        id: get_target_tf_modules
        shell: bash
        run: |
          git fetch origin master

          if [ -z `git diff --dirstat=files,0 --name-only $GITHUB_REF_NAME origin/master | grep -v .github` ]; then
            CHANGED_TF_MODULES_JSON=$(printf '[]\n')

            echo "TF Modules JSON: " $CHANGED_TF_MODULES_JSON
          else
            CHANGED_TF_MODULES=`git diff --dirstat=files,0 --name-only $GITHUB_REF_NAME origin/master | sed -E 's/^[ 0-9.]+% //g' | cut -d '/' -f1 | grep -v .github | uniq | sort`

            echo "TF Modules: " $CHANGED_TF_MODULES

            if [ -z "$CHANGED_TF_MODULES" ]; then
              CHANGED_TF_MODULES_JSON=$(printf '[]\n')
            else
              CHANGED_TF_MODULES_JSON=$(printf '['; for i in ${CHANGED_TF_MODULES[@]}; do printf ' \"%s\", ' $i; done | sed 's/,\([^,]*\)$/\1/'; printf ']\n')
            fi

            echo "TF Modules JSON: " $CHANGED_TF_MODULES_JSON
          fi

          # CHANGED_TF_MODULES=`git diff --dirstat=files,0 --name-only $GITHUB_REF_NAME origin/master | sed -E 's/^[ 0-9.]+% //g' | cut -d '/' -f1 | grep -v .github | uniq | sort`

          # echo "TF Modules: " $CHANGED_TF_MODULES

          # if [ -z "$CHANGED_TF_MODULES" ]; then
          #   CHANGED_TF_MODULES_JSON=$(printf '[]\n')
          # else
          #   CHANGED_TF_MODULES_JSON=$(printf '['; for i in ${CHANGED_TF_MODULES[@]}; do printf ' \"%s\", ' $i; done | sed 's/,\([^,]*\)$/\1/'; printf ']\n')
          # fi

          # echo "TF Modules JSON: " $CHANGED_TF_MODULES_JSON

          echo "::set-output name=tf_modules::$CHANGED_TF_MODULES_JSON"

  perform_security_scan:
    needs: [ get_target_modules ]
    uses: varun-charan/reusable-workflows/.github/workflows/iac-security-scans.yaml@skip-sec-scans-if-no-target-modules
    with:
      upload_sarif: true
      target_dirs: ${{ needs.get_target_modules.outputs.tf_modules }}
      severity: "low"
      terrascan_iac_type: "terraform"
      terrascan_iac_version: "v15"
    secrets:
      snyk_auth_token: ${{ secrets.SNYK_AUTH_TOKEN }}